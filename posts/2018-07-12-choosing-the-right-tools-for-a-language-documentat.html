<!doctype html>
<html lang="en">
<head>
<title>Choosing the Right Tools for a Language Documentation App</title>
<!-- 2018-07-14 Sat 12:05 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="Luke D. Gessler">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style type="text/css">
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<script type="text/javascript">
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script><link rel='stylesheet' type='text/css' href='/css/styles.css'>
            <link href="https://fonts.googleapis.com/css?family=Roboto"
                  rel="stylesheet">
</head>
<body>
<div id="preamble" class="">
<div class="container"><div class="row"><div class="col-md-9"><div style="font-size:11px;text-align:center;"><a style="color:gray;" href="/">Home</a> <a style="color:gray;" href="/posts/">Blog</a></div><div style="margin-top:0px;margin-bottom:-12px;color:#a0a0a0;">Luke D. Gessler</div></div></div></div>
</div>
<div id="content" class="container">
<div class="row"><div class="col-md-9"><h1 class="title">Choosing the Right Tools for a Language Documentation App</h1>
<p>
<i>(You can find the app this post is about <a href="https://lgessler.com/ewan/">here</a>, and its <a href="https://github.com/lgessler/ewan">source on GitHub</a>.)</i>
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Technology has been increasingly recognized as critical for successful <a href="https://en.wikipedia.org/wiki/Language_documentation">language documentation</a> and <a href="https://en.wikipedia.org/wiki/Language_revitalization">development</a>. The premier conference in this field, ICLDC, writes <a href="http://icldc6.icldc-hawaii.org/">on its front page</a> (emphasis mine):
</p>

<blockquote>
<p>
Over the past two decades endangered language documentation and conservation has (re)emerged as a distinct subfield of linguistics with its own methodology and theoretical underpinnings. This <b>reemergence has occurred in parallel with a dramatic technological evolution which has put advanced computing tools in the hands of language documenters</b> and those striving to reclaim and maintain endangered languages. Moreover, technology is also changing traditional user roles, blurring the lines between linguist, speaker, and activist by providing increased access to information. <b>Digital tools have the power to greatly accelerate the language work, but the digital realm also brings new challenges for endangered languages, which sometimes struggle to thrive in a digitally-mediated world.</b>
</p>
</blockquote>

<p>
Despite the increasing awareness of its importance, adoption of technology<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup> in language documentation (langdoc) has been sluggish. There are many reasons for this (see <a href="https://drive.google.com/file/d/0BwccTAxxSD7MeXFOYjJfNzRfUEE/view">Bird's recent paper</a>), but the most important is that there is simply not enough labor. 
</p>

<p>
Software development is time-consuming work: done adequately, it is a demanding technical activity, and done well, it is as much ethnographic as it is technical. And since almost nobody in langdoc can afford a team of salaried engineers<sup><a id="fnr.2" name="fnr.2" class="footref" href="#fn.2">2</a></sup>, most langdoc apps are made by developers who are juggling many other responsibilities, making it difficult for them to meet their users' needs with the time they have available.
</p>

<p>
If getting more people involved isn't possible, then all that's left is to make developers more productive. But how might that be possible?
</p>

<p>
I see an opportunity: using better tools. So far, the community has not strayed too far from very common tools (JS, Java, C#, Python), and it has not yet solved certain problems, including good UX, collaboration, cross-platform portability, and offline support. Choosing the right programming language and libraries for the task can make development that might have been an aching slog nearly trivial. Of course, a new tool should not be used merely <a href="https://blog.codinghorror.com/the-magpie-developer/">for novelty's sake</a>. As long as we pick tools by their usefulness, and not their fashionability or novelty, we might be able to make better use of the precious little time and energy langdoc developers have to do their work<sup><a id="fnr.3" name="fnr.3" class="footref" href="#fn.3">3</a></sup>.
</p>


<figure>
<p><img src="./img/flex_lex_edit.png" class="img-responsive" alt="flex_lex_edit.png">
</p>
<figcaption><span class="figure-number">Figure 1:</span> A view in SIL's <a href="https://software.sil.org/fieldworks/">Field Lexicon Explorer</a>, a Windows desktop application used for fieldwork and lexicon management. (<a href="https://software.sil.org/fieldworks/resources/tutorial/lexicon/lexicon-edit/">src</a>)</figcaption>
</figure>


<p>
To investigate this possibility, I recreated a subset of the popular linguistic annotation tool, <a href="https://tla.mpi.nl/tools/tla-tools/elan/">ELAN</a>, using the tools I considered most promising for langdoc apps. If I'm interested in langdoc apps, why did I clone ELAN, which is a linguistic annotation app? In short, because (1) this let me skip the design phase, (2) ELAN is relatively small, (3) ELAN's use-patterns are similar enough a langdoc app's, and (4) ELAN has non-trivial features that a simple <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> app does not, ensuring that I would test my tools against hard problems.
</p>

<p>
This post shares my experience in building this ELAN clone, <a href="https://github.com/lgessler/ewan">EWAN</a>. In section 2, I will outline my motivations for why I chose the tools I used. In section 3, I will discuss my implementation. In section 4, I go into more depth on whether the tools I chose did in fact make a difference. In section 5, I conclude.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Requirements and tool choices</h2>
<div class="outline-text-2" id="text-2">
<p>
To guide my choices, I paid particular attention to four qualities that I thought would be important for the kind of langdoc app I'm imagining. These are: being built on the most suitable platform; having a minimum of UI code; having offline support; and being built with the most suitable language.
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Suitable platform: browser</h3>
<div class="outline-text-3" id="text-2-1">
<p>
15 years ago, the only platform that would have made sense for a langdoc app was the desktop. These days, there are three: the desktop, the web browser, and the mobile phone. 
</p>

<p>
Desktop applications allow your app the most freedom to do what it wants, but they have critical shortcomings that limit their ease of use and therefore adoption. Depending on how the application was developed, it may be limited to a specific platform&#x2013;for example, <a href="https://software.sil.org/fieldworks/">SIL's FLEx</a> is limited to Windows operating systems. And even if the program does support most desktop platforms, installation may be complicated if the program holds the user accountable for installing language runtimes, codecs, etc. Since users are usually not technically trained, this presents a significant barrier to entry.
</p>

<p>
The web browser, by comparison, is slightly constrained in terms of its facilities for app developers<sup><a id="fnr.4" name="fnr.4" class="footref" href="#fn.4">4</a></sup>, but it is still powerful enough to support almost any kind of app. Importantly, there is <i>no installation</i><sup><a id="fnr.5" name="fnr.5" class="footref" href="#fn.5">5</a></sup> required with a browser application: no codecs to install, no fuss about which Java version you have installed, no operating system heartache. Further, the technologies involved (HTML, JS, CSS) were designed to be easy to learn. This has a double benefit: it makes the apps a little easier to develop (since the developers likely already know the tools involved), and it also makes it very easy to develop some kind of plugin system for power users to write scripts to help them accomplish their tasks. (More on this in section 3.6.3.)
</p>

<p>
The mobile phone is the most constrained of the three platforms, primarily due to its form factor. However, this has also enabled its ubiquity and portability: there are often phones where computers can't be because of financial or logistical limitations. This makes it uniquely suited to apps that are designed for community members. <a href="https://lig-aikuma.imag.fr/">Aikuma</a> has enjoyed success as a langdoc tool for audio recordings, and <a href="https://drive.google.com/file/d/0BwccTAxxSD7MeXFOYjJfNzRfUEE/view">there's good reason to think they could be a critical part of documentation and revitalization strategies that heavily involve community members</a>. However, the traditional langdoc tasks that you'd imagine a documentary linguist engaging in are not most effectively carried out using a phone. Moreover, the platform is fragmented: there are two major operating systems, Android and iOS, which require different development tools<sup><a id="fnr.6" name="fnr.6" class="footref" href="#fn.6">6</a></sup>.
</p>

<p>
There is a clear winner, then, if we intend to build a comprehensive app that is to serve the major requirements of doing langdoc. The web browser has the ease of use, maturity, and comprehensive feature set to serve as a foundation.
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Minimal UI development: Material-UI</h3>
<div class="outline-text-3" id="text-2-2">

<figure>
<p><img src="./img/trafikito.jpg" class="img-responsive" alt="trafikito.jpg">
</p>
<figcaption><span class="figure-number">Figure 2:</span> Material-UI components automatically change their appearance depending on the kind of device being used. (<a href="https://material-ui.com/static/images/showcase/trafikito-monitoring.jpg">src</a>)</figcaption>
</figure>

<p>
Apps share much in common in their UI code: most popular apps rely on (I'd say) at most a couple dozen foundational component concepts. A high-quality UI library can save a great amount of time that would have been spent making buggy reimplementations of common components. There were many choices for this piece, but I chose <a href="https://material-ui.com/">Material-UI</a> for its long-term stability, its excellent support for mobile devices, eye to usability, and comprehensive component selection. (This also committed me to using <a href="https://reactjs.org/">React</a>, the most popular browser UI framework for a few years now.)
</p>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Offline-first: PouchDB</h3>
<div class="outline-text-3" id="text-2-3">

<figure>
<p><img src="./img/pdb_diagram.png" class="img-responsive" alt="pdb_diagram.png">
</p>
<figcaption><span class="figure-number">Figure 3:</span> PouchDB is located in the user's web browser, making a network connection unnecessary for the app to work.</figcaption>
</figure>

<p>
Having an app that still works when you're offline is important if you intend your app for use in the field. This is a historically unusual (though <a href="http://offlinefirst.org/">increasingly</a> <a href="https://en.wikipedia.org/wiki/Progressive_Web_Apps">common</a>) requirement for web browsers, so there was only one suitable option for a library that would enable this: <a href="https://pouchdb.com/">PouchDB</a>. PouchDB is actually a full JavaScript implementation of a more traditional DB that sits on a server, <a href="https://en.wikipedia.org/wiki/Apache_CouchDB">CouchDB</a>. This means that PouchDB has all the power of a traditional database, but its methods can be directly invoked from the browser app code instead of over a connection. Moreover, since CouchDB was designed to tolerate poor network conditions, PouchDB can gracefully and losslessly merge data that's been kept apart for a while (the kind you'd expect if, say, two linguists glossed hundreds of sentences and tweaked lexicon entries in the absence of an internet connection), and as a bonus, it makes Google Docs-style concurrent editing easy (see section 3.6.2).
</p>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> Cheap maintenance: ClojureScript</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Software requires <a href="https://en.wikipedia.org/wiki/Software_rot">maintenance</a>. Apps necessarily make assumptions about the behavior of all of the code they use, and when that changes, the app's code might also need to change to keep working.
</p>

<p>
This code can be used within the app itself, like a JSON parser inside a program, or it could be used in the making of the app. Code in this latter category (compilers, testing frameworks, deployment tools, etc.) also changes, and nowhere has this been more true than in the JavaScript ecosystem since the mid-2000's. For complicated reasons, an entirely new set of utilities, would appear on the scene once every 1-2 years, often often with significant improvements. (<a href="https://www.alexkras.com/my-history-with-web-development-or-javascript-fatigue/">A brief history</a>.) This leaves you with two options if you are using last year's tools: (1) double down and accept the fact that your tools might be obsolete and unmaintained in a few years' time, or (2) accept that last year's tools must be abandoned, and migrate to this year's tools. Both lead to a great amount of work that has nothing to do with delivering features to users.
</p>

<p>
I figured that it would be best to avoid this if possible. Looking around, the only language that impressed me with its cheap maintenance, both with respect to tooling and libraries, was <a href="http://www.clojurenewbieguide.com/">ClojureScript</a>, a Lisp-family language that compiles to JavaScript. Its standard build tool, <a href="https://en.wikipedia.org/wiki/Leiningen_(software)">Leiningen</a>, has kept its place as most popular build tool since at least 2010 (!). The language itself is also remarkably stable: the core of ClojureScript (which tries to remain as close to Clojure as possible) has not been significantly changed since 2009 and looks nearly identical to ClojureScript written today. That can't be said for 2009 JavaScript, which is now separated from the present time by several ECMAScript specification updates and shifts in style practices. On the library side, the ClojureScript ecosystem is large enough for that you can be reasonably certain the community will keep critical parts of infrastructure maintained for years to come.
</p>

<p>
Beyond the cheapness of maintenance, ClojureScript also has benefits conferred upon it by its place in the Lisp family of languages, which will be discussed later.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Implementation and comparison</h2>
<div class="outline-text-2" id="text-3">
<p>
In about 200 hours of development time, I was able to produce a limited port of ELAN, which I call EWAN. It is <b>not</b> a suitable replacement for the desktop application because of its lack of some core features. But it was complete enough for me to feel confident that I had understood how much my tools had helped me compared to their more common counterparts. In this section, I will discuss both what I was able to achieve and extensions that I could were easily within reach with just a little more development time. You can <a href="https://lgessler.com/ewan/">try out the app for yourself</a>, and <a href="https://github.com/lgessler/ewan">view its source code</a>. 
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Loading and representing ELAN files</h3>
<div class="outline-text-3" id="text-3-1">

<figure>
<p><img src="./img/ewan_upload_elan_file.png" class="img-responsive" alt="ewan_upload_elan_file.png">
</p>
<figcaption><span class="figure-number">Figure 4:</span> Uploading an ELAN file with EWAN</figcaption>
</figure>

<p>
EWAN is able to parse existing ELAN files that conform to <a href="http://www.mpi.nl/tools/elan/EAF_Annotation_Format_3.0_and_ELAN.pdf">ELAN Annotation Format v3.0</a>. The user is prompted to select the file from their file system and upload any accompanying media files. The <a href="https://developer.mozilla.org/en-US/docs/Web/API/File">HTML5 File API</a> made this part a breeze to implement.
</p>

<p>
<a href="https://github.com/lgessler/ewan/blob/master/src/cljs/ewan/eaf30/eaf30.cljs#L102">At this point</a>, after the file has been read, it is an XML string. ClojureScript has a built in XML parser, <a href="https://github.com/clojure/data.xml">clojure.data.xml</a>, which parses the string into an XML object structure, and that in turn is <a href="https://github.com/lgessler/ewan/blob/master/src/cljs/ewan/eaf30/eaf30.cljs#L40">converted into a format which uses Clojure-native data structures</a> called <a href="https://github.com/weavejester/hiccup">Hiccup</a>. 
</p>

<p>
The end result is that something like this:
</p>

<div class="org-src-container">

<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">ANNOTATION_DOCUMENT</span> <span class="org-nxml-attribute-local-name">VERSION</span>=<span class="org-string">"3.0"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">HEADER</span> <span class="org-nxml-attribute-local-name">TIME_UNITS</span>=<span class="org-string">"milliseconds"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">MEDIA_DESCRIPTOR</span> 
        <span class="org-nxml-attribute-local-name">MEDIA_URL</span>=<span class="org-string">"file:///D:/Data/elan/elan-example1.mpg"</span> 
        <span class="org-nxml-attribute-local-name">MIME_TYPE</span>=<span class="org-string">"video/mpeg"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">HEADER</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">TIME_ORDER</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">... </span><span class="org-comment-delimiter">--&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">TIME_ORDER</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">... </span><span class="org-comment-delimiter">--&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">ANNOTATION_DOCUMENT</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
is turned into this:
</p>

<div class="org-src-container">

<pre class="src src-clojurescript"><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-clojure-keyword">:annotation-document</span> 
 <span class="org-rainbow-delimiters-depth-2">{</span><span class="org-clojure-keyword">:version</span> <span class="org-string">"3.0"</span><span class="org-rainbow-delimiters-depth-2">}</span>
 <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-clojure-keyword">:header</span> <span class="org-rainbow-delimiters-depth-3">{</span><span class="org-clojure-keyword">:time-units</span> <span class="org-string">"milliseconds"</span><span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:media-descriptor</span> 
   <span class="org-rainbow-delimiters-depth-4">{</span><span class="org-clojure-keyword">:media-url</span> <span class="org-string">"file:///D:/Data/elan/elan-example1.mpg"</span> 
    <span class="org-clojure-keyword">:mime-type</span> <span class="org-string">"video/mpeg"</span><span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span>
 <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-clojure-keyword">:time-order</span> 
  <span class="org-comment-delimiter">;; </span><span class="org-comment">...</span>
  <span class="org-rainbow-delimiters-depth-2">]</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">...</span>
<span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>

<p>
<i>(In Python, this would be something like</i> <code>["annotation-document", {"version": "3.0"}, ...</code>. <i>A</i> <code>:keyword</code> <i>is a special Lisp type that you can think of as an enum value.)</i>
</p>

<p>
This is helpful because we're going to be editing the file a lot, and it's easiest to work with native data structures than with strings or XML nodes. 
</p>

<p>
A brief digression: it's worth noting how ClojureScript's recommended style helps you clearly communicate intent by encouraging you to write many small functions with helpful names. For example, this is <a href="https://github.com/lgessler/ewan/blob/master/src/cljs/ewan/eaf30/eaf30.cljs#L102">the function that is used to turn the raw file string into Hiccup</a>:
</p>

<div class="org-src-container">

<pre class="src src-clojurescript"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">eaf-str-&gt;hiccup</span>
  <span class="org-doc">"Takes the raw text of an EAF file, parses it into XML, and gives the hiccup</span>
<span class="org-doc">  analog of that XML."</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>str<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">-&gt;</span> str
      unsafe-remove-whitespace
      <span class="org-type">xml</span>/parse-str
      xml-&gt;hiccup<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
(In Java-style syntax, this means <code>xml2hiccup(xml.parseStr(unsafeRemoveWhitespace(str)))</code>). Each step of this process has been factored into another function, and each function's name tells you what it does at a high level. In an imperative language, you can also achieve this style, but it is tempting and often easier to put all of your work into a single loop, making it harder to see at a glance all the conceptually distinct tasks that are being mixed together<sup><a id="fnr.7" name="fnr.7" class="footref" href="#fn.7">7</a></sup>.  
</p>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Ensuring data integrity with spec</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Back to our main thread, we now have a representation of the ELAN file in Clojure-native data structures. If you're like me, you should now be feeling nervous about how we'll ensure that this giant structure remains valid for export at any moment. 
</p>

<p>
Fortunately, Clojure has an amazing core library called <a href="https://clojure.org/guides/spec">spec</a> that allows us to easily do this. Spec not only helps us check whether the <i>shape</i> of the data is correct (this is what a static type system would also be able to accomplish), but it also lets us easily check whether the <i>meaning</i> of the data is correct. This lets you, e.g., write a rule that declares "All ID's that are referenced by attributes like <code>ref-annotation</code> on other nodes must actually exist on a node somewhere in the document." This is something most type systems would not be able to accomplish for you. 
</p>

<p>
Let's see what that looks like for a toy example: consider an XML format that has books and authors, where <code>author</code> elements have an <code>id</code> attribute and <code>book</code> elements have an <code>author-id</code> attribute which must refer to an <code>author</code> element's <code>id</code> attribute. This is the XML:
</p>

<div class="org-src-container">

<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">library</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">authors</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">author</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"Plath"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">author</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"Valmiki"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">author</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"Apuleius"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">authors</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">books</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">book</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"Ramayana"</span> <span class="org-nxml-attribute-local-name">author-id</span>=<span class="org-string">"Valmiki"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">book</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"To The Lighthouse"</span> <span class="org-nxml-attribute-local-name">author-id</span>=<span class="org-string">"Plath"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">book</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"Orlando"</span> <span class="org-nxml-attribute-local-name">author-id</span>=<span class="org-string">"Plath"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">book</span> <span class="org-nxml-attribute-local-name">id</span>=<span class="org-string">"The Golden Ass"</span> <span class="org-nxml-attribute-local-name">author-id</span>=<span class="org-string">"Apuleius"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">books</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">library</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
In hiccup, this is:
</p>

<div class="org-src-container">

<pre class="src src-clojurescript"><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-clojure-keyword">:library</span>
 <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-clojure-keyword">:authors</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-4">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-4">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Valmiki"</span><span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-4">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Apuleius"</span><span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span>
 <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-clojure-keyword">:books</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-4">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Ramayana"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Valmiki"</span><span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-4">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"To The Lighthouse"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-4">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Orlando"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-4">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"The Golden Ass"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Apuleius"</span><span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">]</span>
</pre>
</div>

<p>
Now, we begin the implementation of the spec by defining the constituent elements of <code>library</code>:
</p>

<div class="org-src-container">

<pre class="src src-clojurescript"><span class="org-comment-delimiter">;; </span><span class="org-comment">import clojure.spec as s</span>
<span class="org-rainbow-delimiters-depth-1">(</span>require '<span class="org-rainbow-delimiters-depth-2">[</span>clojure.spec.alpha <span class="org-clojure-keyword">:as</span> s<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">elt-name</span> 
  <span class="org-doc">"Returns a function that returns true if its argument is equal to `</span><span class="org-doc"><span class="org-constant">name</span></span><span class="org-doc">`"</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>name<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-rainbow-delimiters-depth-2">(</span>fn <span class="org-rainbow-delimiters-depth-3">[</span>tag-name<span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">(</span>= name tag-name<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">an id is something that makes the single-argument function `</span><span class="org-comment"><span class="org-constant">string?</span></span><span class="org-comment">` return true</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/<span class="org-keyword">def</span> <span class="org-function-name">::id</span> string?<span class="org-rainbow-delimiters-depth-1">)</span> 

<span class="org-comment-delimiter">;; </span><span class="org-comment">an author element is a vector of two items: a tag name that has the value</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">`</span><span class="org-comment"><span class="org-constant">:author</span></span><span class="org-comment">`, and a map (i.e., a hash-map) that contains a key `</span><span class="org-comment"><span class="org-constant">:id</span></span><span class="org-comment">`, whose spec</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">we just defined above</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/<span class="org-keyword">def</span> <span class="org-function-name">::author</span> 
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">s</span>/cat <span class="org-clojure-keyword">:tag</span> <span class="org-rainbow-delimiters-depth-3">(</span>elt-name <span class="org-clojure-keyword">:author</span><span class="org-rainbow-delimiters-depth-3">)</span> 
         <span class="org-clojure-keyword">:attrs</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">s</span>/keys <span class="org-clojure-keyword">:req-un</span> <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">::id</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">the authors element is a vector of at least one item: a tag name that has the</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">value `</span><span class="org-comment"><span class="org-constant">:authors</span></span><span class="org-comment">`, and child elements which conform to the `</span><span class="org-comment"><span class="org-constant">::author</span></span><span class="org-comment">` spec</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/<span class="org-keyword">def</span> <span class="org-function-name">::authors</span> 
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">s</span>/cat <span class="org-clojure-keyword">:tag</span> <span class="org-rainbow-delimiters-depth-3">(</span>elt-name <span class="org-clojure-keyword">:authors</span><span class="org-rainbow-delimiters-depth-3">)</span> 
         <span class="org-clojure-keyword">:children</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">s</span>/* <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">s</span>/spec <span class="org-clojure-keyword">::author</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">an author-id is also a string</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/<span class="org-keyword">def</span> <span class="org-function-name">::author-id</span> string?<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">a book element is a vector of two items: a tag name that has the value `</span><span class="org-comment"><span class="org-constant">:book</span></span><span class="org-comment">`,</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">and a map that contains the keys `</span><span class="org-comment"><span class="org-constant">:id</span></span><span class="org-comment">` and `</span><span class="org-comment"><span class="org-constant">:author-id</span></span><span class="org-comment">`</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/<span class="org-keyword">def</span> <span class="org-function-name">::book</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">s</span>/cat <span class="org-clojure-keyword">:tag</span> <span class="org-rainbow-delimiters-depth-3">(</span>elt-name <span class="org-clojure-keyword">:book</span><span class="org-rainbow-delimiters-depth-3">)</span> 
         <span class="org-clojure-keyword">:attrs</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">s</span>/keys <span class="org-clojure-keyword">:req-un</span> <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">::id</span> <span class="org-clojure-keyword">::author-id</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">the books element is a vector of at least one item: a tag name that has the</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">value `</span><span class="org-comment"><span class="org-constant">:books</span></span><span class="org-comment">`, and child elements which conform to the `</span><span class="org-comment"><span class="org-constant">::book</span></span><span class="org-comment">` spec</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/<span class="org-keyword">def</span> <span class="org-function-name">::books</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">s</span>/cat <span class="org-clojure-keyword">:tag</span> <span class="org-rainbow-delimiters-depth-3">(</span>elt-name <span class="org-clojure-keyword">:books</span><span class="org-rainbow-delimiters-depth-3">)</span> 
         <span class="org-clojure-keyword">:children</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">s</span>/* <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">s</span>/spec <span class="org-clojure-keyword">::book</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">the library element is a vector of three items: a tag name that has the value </span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">`</span><span class="org-comment"><span class="org-constant">:authors</span></span><span class="org-comment">`, an element that conforms to the `</span><span class="org-comment"><span class="org-constant">::authors</span></span><span class="org-comment">` spec, and an element that</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">conforms to the `</span><span class="org-comment"><span class="org-constant">::books</span></span><span class="org-comment">` spec, in that order.</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/<span class="org-keyword">def</span> <span class="org-function-name">::library</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">s</span>/cat <span class="org-clojure-keyword">:tag</span> <span class="org-rainbow-delimiters-depth-3">(</span>elt-name <span class="org-clojure-keyword">:library</span><span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-clojure-keyword">:authors</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">s</span>/spec <span class="org-clojure-keyword">::authors</span><span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-clojure-keyword">:books</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">s</span>/spec <span class="org-clojure-keyword">::books</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Now, we can check data structures against any part of the spec and ensure that our data conforms to it:
</p>

<div class="org-src-container">

<pre class="src src-clojurescript"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/valid? <span class="org-clojure-keyword">::id</span> <span class="org-string">"Ulysses"</span><span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/valid? <span class="org-clojure-keyword">::id</span> <span class="org-highlight-numbers-number">2</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; false</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/explain <span class="org-clojure-keyword">::id</span> <span class="org-highlight-numbers-number">2</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; val: 2 fails spec: ::id predicate: string?</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/valid? 
 <span class="org-clojure-keyword">::library</span> 
 <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-clojure-keyword">:library</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:authors</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Valmiki"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Apuleius"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:books</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Ramayana"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Valmiki"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"To The Lighthouse"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Orlando"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"The Golden Ass"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Apuleius"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>
</pre>
</div>

<p>
Note that our implementation isn't done yet: if we have a book with an <code>:author-id</code> that doesn't exist, our spec will still be happy with it since all we require of the <code>:author-id</code> is that it be a string:
</p>

<div class="org-src-container">

<pre class="src src-clojurescript"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/valid? 
 <span class="org-clojure-keyword">::library</span> 
 <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-clojure-keyword">:library</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:authors</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:books</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"The Golden Ass"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Apuleius"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>
</pre>
</div>

<p>
To amend this, we write a function that checks the structure and ensures that every <code>:author-id</code> corresponds to an <code>:id</code> that actually exists on an author element, and then we revise our spec for <code>::library</code> from earlier by composing this function using <code>s/and</code> with what we have already:
</p>

<div class="org-src-container">

<pre class="src src-clojurescript"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">defn</span> <span class="org-function-name">valid-ids</span>
  <span class="org-rainbow-delimiters-depth-2">[</span>library<span class="org-rainbow-delimiters-depth-2">]</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">use destructuring assignment to pull out elements</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">let</span> <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-rainbow-delimiters-depth-4">[</span>library-tag 
         <span class="org-rainbow-delimiters-depth-5">[</span>authors-tag &amp; author-elts<span class="org-rainbow-delimiters-depth-5">]</span> 
         <span class="org-rainbow-delimiters-depth-5">[</span>books-tag &amp; book-elts<span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">]</span> library
        <span class="org-comment-delimiter">;; </span><span class="org-comment">obtain the :author-id values and put them into a set</span>
        author-ids <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">-&gt;&gt;</span> author-elts
                        <span class="org-rainbow-delimiters-depth-5">(</span>map <span class="org-rainbow-delimiters-depth-6">(</span>comp <span class="org-clojure-keyword">:id</span> second<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>
                        set<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">-&gt;&gt;</span> book-elts 
         <span class="org-comment-delimiter">;; </span><span class="org-comment">this function looks at every book and returns true</span>
         <span class="org-comment-delimiter">;; </span><span class="org-comment">if there is at least one book elt that has an :author-id </span>
         <span class="org-comment-delimiter">;; </span><span class="org-comment">value that is not present on an :author element</span>
         <span class="org-rainbow-delimiters-depth-4">(</span>some <span class="org-rainbow-delimiters-depth-5">(</span>fn <span class="org-rainbow-delimiters-depth-6">[</span><span class="org-rainbow-delimiters-depth-7">[</span>_ <span class="org-rainbow-delimiters-depth-8">{</span><span class="org-clojure-keyword">:keys</span> <span class="org-rainbow-delimiters-depth-9">[</span>author-id<span class="org-rainbow-delimiters-depth-9">]</span><span class="org-rainbow-delimiters-depth-8">}</span><span class="org-rainbow-delimiters-depth-7">]</span><span class="org-rainbow-delimiters-depth-6">]</span>
                 <span class="org-rainbow-delimiters-depth-6">(</span>not <span class="org-rainbow-delimiters-depth-7">(</span>some? <span class="org-rainbow-delimiters-depth-8">(</span>get author-ids author-id<span class="org-rainbow-delimiters-depth-8">)</span><span class="org-rainbow-delimiters-depth-7">)</span><span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
         not<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/<span class="org-keyword">def</span> <span class="org-function-name">::library</span>
  <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">s</span>/and valid-ids
         <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">s</span>/cat <span class="org-clojure-keyword">:tag</span> <span class="org-rainbow-delimiters-depth-4">(</span>elt-name <span class="org-clojure-keyword">:library</span><span class="org-rainbow-delimiters-depth-4">)</span>
                <span class="org-clojure-keyword">:authors</span> <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">s</span>/spec <span class="org-clojure-keyword">::authors</span><span class="org-rainbow-delimiters-depth-4">)</span>
                <span class="org-clojure-keyword">:books</span> <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">s</span>/spec <span class="org-clojure-keyword">::books</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
Now, it behaves like we want it to:
</p>

<div class="org-src-container">

<pre class="src src-clojurescript"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/valid?
 <span class="org-clojure-keyword">::library</span> 
 <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-clojure-keyword">:library</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:authors</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Valmiki"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Apuleius"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:books</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Ramayana"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Valmiki"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"To The Lighthouse"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Orlando"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"The Golden Ass"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Apuleius"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>

<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">s</span>/valid?
 <span class="org-clojure-keyword">::library</span> 
 <span class="org-rainbow-delimiters-depth-2">[</span><span class="org-clojure-keyword">:library</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:authors</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Valmiki"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:author</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Apuleius"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">]</span>
  <span class="org-rainbow-delimiters-depth-3">[</span><span class="org-clojure-keyword">:books</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Ramayana"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Valmiki"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"To The Lighthouse"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"Orlando"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Plath"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"The Golden Ass"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Apuleius"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span>
   <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-clojure-keyword">:book</span> <span class="org-rainbow-delimiters-depth-5">{</span><span class="org-clojure-keyword">:id</span> <span class="org-string">"The God of Small Things"</span> <span class="org-clojure-keyword">:author-id</span> <span class="org-string">"Roy"</span><span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; false</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Roy is not listed as an author</span>
</pre>
</div>

<p>
<a href="http://blog.fogus.me/2009/12/21/clojures-pre-and-post/">Clojure's pre and post conditions</a> make it easy for you to <a href="https://github.com/lgessler/ewan/blob/master/src/cljs/ewan/eaf30/core.cljs#L761">insert a spec check wherever you're making changes to the data</a>. These checks will run during development, but you may opt to have them compiled out when you publish your app, allowing you to have this safety during development without incurring a performance hit in production. Further, when your value fails a spec check, you can ask spec to <code>explain</code> what went wrong<sup><a id="fnr.8" name="fnr.8" class="footref" href="#fn.8">8</a></sup>. For a good explanation of how spec provides safety beyond what (traditional) type systems provide, see <a href="https://blog.jeaye.com/2017/05/31/clojure-spec/">this blog post</a>.
</p>

<p>
In short, the critical thing here is just that clojure.spec is lets us remain confident that our data still represents a valid ELAN file as we perform changes to it. The JS ecosystem does have <a href="https://reactjs.org/docs/typechecking-with-proptypes.html">similar</a> <a href="https://github.com/prayerslayer/js.spec">libraries</a>, but they are not as feature-complete or concise as clojure.spec.
</p>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Data persistence and offline support with PouchDB</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Now that we have the ELAN file in a format we can work with, we can persist it to PouchDB so it'll be available to the user across sessions. This is easy: we create the database by using simple JS interop, and whenever we make a change to it, we use PouchDB's <code>put</code> method to persist the change. Doing that in JS:
</p>

<div class="org-src-container">

<pre class="src src-javascript"><span class="org-keyword">var</span> <span class="org-variable-name">db</span> = <span class="org-keyword">new</span> <span class="org-type">PouchDB</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">'ewan-db'</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">...</span>
db.put<span class="org-rainbow-delimiters-depth-1">(</span>updatedDoc, <span class="org-keyword">function</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-variable-name">error</span>, <span class="org-variable-name">response</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> 
  <span class="org-comment-delimiter">// </span><span class="org-comment">...</span>
<span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
&#x2026; looks a lot like doing it in CLJS:
</p>

<div class="org-src-container">

<pre class="src src-clojurescript"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">def</span> <span class="org-variable-name">db</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">js</span>/PouchDB. <span class="org-string">"ewan-db"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">...</span>
<span class="org-rainbow-delimiters-depth-1">(</span>.put db updated-doc <span class="org-rainbow-delimiters-depth-2">(</span>fn <span class="org-rainbow-delimiters-depth-3">[</span>error response<span class="org-rainbow-delimiters-depth-3">]</span>
                       <span class="org-comment-delimiter">;; </span><span class="org-comment">...</span>
                       <span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<p>
As discussed above, since the database exists on the user's hard disk and not remotely over an internet connection, this gives us offline support for free. Had we used a traditional database, we would have had to use PouchDB or a similar library built on top of <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API">browser storage</a> API's, essentially meaning that we'd need to implement a persistence layer twice.
</p>

<p>
There is also a further benefit: since we don't need to interact with a remote database, we do not need to write any server code! Traditionally, an application like this would send an HTTP request to a server, and the server would communicate with the database and also perform any actions not directly related to manipulations of the data in the database. If an application relies heavily on actions like these, such as sending emails or doing lots of computationally intensive media processing, it is probably a good idea to introduce this extra layer between the client and the database. But if your app only rarely needs to do anything other than change and read data in the database, it is a waste of effort to have this extra layer between the client and the database, provided your database can provide all the needed security controls<sup><a id="fnr.9" name="fnr.9" class="footref" href="#fn.9">9</a></sup>. Since PouchDB sits on the client and can directly communicate with CouchDB (which has <a href="http://docs.couchdb.org/en/2.0.0/intro/security.html">acceptable security features</a>), we can skip the app server layer entirely<sup><a id="fnr.10" name="fnr.10" class="footref" href="#fn.10">10</a></sup>. 
</p>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Free UI with Material-UI</h3>
<div class="outline-text-3" id="text-3-4">
<p>
k<img src="./img/ewan_edit.png" class="img-responsive" alt="ewan_edit.png">
</p>

<p>
The entire project's UI was implemented using Material-UI. In the screenshot above, custom components are implemented on top of the basic components Material-UI provides. Material-UI comes with a <a href="https://material.io/tools/icons/?style=baseline">massive icon library</a>, which I used for the buttons on the video player. The most basic parts of ELAN's UI have been carried over, including the time cursor, the basic tier view, and the time bar. 
</p>

<p>
The version of Material-UI that I used, 0.x, is not mobile-friendly, but its newest release, 1.0, is responsive! I don't know if you'd want to use a complicated app like ELAN on your phone, but I could see this being an incredible time saver for other, less complicated apps. An adequate mobile interface to your app that comes for free is a big deal.
</p>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Managing state with re-frame</h3>
<div class="outline-text-3" id="text-3-5">
<p>
As I just mentioned, to manage state in my app, I used <a href="https://github.com/Day8/re-frame">re-frame</a>. <a href="https://github.com/Day8/re-frame/blob/master/docs/MentalModelOmnibus.md">Re-frame</a> is a framework for <a href="https://en.wikipedia.org/wiki/Single-page_application">single-page apps</a> that essentially achieves the same things a typical <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">modelviewcontroller</a> framework does: it keeps models of your app data, allows your UI elements to consume data from those models, and gives you a way to make changes to your models. 
</p>


<figure>
<p><img src="./img/one-and-two-way-binding.png" class="img-responsive" alt="one-and-two-way-binding.png">
</p>
<figcaption><span class="figure-number">Figure 5:</span> One-way vs. two-way binding. (<a href="http://www.plymouthhistorystore.org/one-way-binding-not-updating.php">src</a>)</figcaption>
</figure>

<p>
In this last function, however, it imposes a constraint. Other comparable frameworks, such as Angular or Ember, allow you to both (1) directly modify UI state (like the value of a text input field), which is then propagated directly to model state; and (2) modify model state, which is then propagated to UI state. This is called <a href="https://stackoverflow.com/questions/13504906/what-is-two-way-binding">two-way binding</a>. Re-frame (along with other frameworks like React), on the other hand, disallows the first kind of modification, which leaves model state propagating to UI state as the only way for your app to make changes. (UI state can still modify application state <i>somehow</i>, obviously&#x2013;it is just through indirect means. For re-frame, the UI element dispatches a re-frame event, and the event is allowed to update the model.)
</p>

<p>
Why take away this freedom from the user? If only changes of type (2) are allowed, then the functions which re-frame and React use to generate HTML from data become <a href="https://en.wikipedia.org/wiki/Pure_function">very predictable functions</a> of their inputs, which makes reasoning about them incredibly easy. Further, if changes can only propagate in one direction, then the chain of updates can only be as long as the height of your UI component tree. 
</p>

<p>
On the other hand, if you allow changes of type (1) to occur, this makes the <a href="https://hashnode.com/post/what-are-the-exact-demerits-of-two-way-data-binding-ciibz8fnq01f8j3xthmjjs6di">relationship between models and views many-to-many</a>. If you are not careful, this will lead to complicated cascades of changes from the change of a single value as they propagate up and down your component tree, making execution in your app difficult to follow and comprehend.
</p>

<p>
So re-frame, strictly speaking, <i>does</i> take some expressive freedom away from you as a user, but in exchange, you get the peace of mind that comes with having strong expectations about how your app must behave when you are trying to reason about it. The codebase I ended up with, while small (~3000 lines of code) and written by one person, was big enough for me to appreciate the productivity gains that come with this check on cognitive strain. My code had had distinct and minimally-interleaved flows of execution, and obviously there was no trouble keeping UI in sync with the data. Had I continued developing this project further into an even larger one, I would have felt confident that I would be able to keep it readable and easily extensible everywhere.
</p>
</div>
</div>

<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6"><span class="section-number-3">3.6</span> Extensions</h3>
<div class="outline-text-3" id="text-3-6">
<p>
So far we have surveyed what I actually implemented. There were other features that I did not have the time to implement, but got close enough to to have a concrete implementation plan.
</p>
</div>

<div id="outline-container-sec-3-6-1" class="outline-4">
<h4 id="sec-3-6-1"><span class="section-number-4">3.6.1</span> Collaboration</h4>
<div class="outline-text-4" id="text-3-6-1">
<blockquote>
<p>
The way I like to think about CouchDB is this: CouchDB is bad at everything, except syncing. And it turns out that's the most important feature you could ever ask for, for many types of software. &#x2013; <a href="https://pouchdb.com/guides/replication.html">Jason Smith</a>
</p>
</blockquote>

<p>
As mentioned above, PouchDB, the persistence layer in this project, is a full implementation of CouchDB, the major difference being that PouchDB runs in an end user's internet browser while CouchDB runs on a dedicated machine like a traditional server. CouchDB was designed to make synchronization of work easy, and that also extends to PouchDB. 
</p>

<p>
With some small updates to the UI (mostly consisting of a login system), an organization would be able to set up their own instance of CouchDB and use it to share work with each other. For example, suppose Alice and Betsy are collaborating on annotating an hour-long video in EWAN with Alice taking the first half and Betsy taking the latter half. They would be able to do their work in parallel and merge their work at the end so that the CouchDB server has what both of them has done. (And then, since the instances of PouchDB running on their own machines would also receive the changes from the master CouchDB server.) This kind of collaboration could also occur if, say, Alice and Betsy are annotating different videos.
</p>
</div>
</div>

<div id="outline-container-sec-3-6-2" class="outline-4">
<h4 id="sec-3-6-2"><span class="section-number-4">3.6.2</span> Real-time editing</h4>
<div class="outline-text-4" id="text-3-6-2">
<p>
It is also possible to extend the program to make the interaction above happen in real time: instead of syncing after they've completed their work, the work Alice and Betsy are doing could be getting synced up in real time just like on Google Docs. PouchDB has a <a href="https://pouchdb.com/guides/replication.html#live%E2%80%93replication">live replication mode</a>. Adding support for this requires a little bit more support on the application level to handle the incoming changes, but this work pales in comparison to the work it would have taken to implement this from scratch: the <i>hard</i> part of this feature (sharing changes in real time across clients and handling the conflicts that will inevitably emerge) has already been taken care of by PouchDB. This feature probably would have taken at least 10 if not 100 times more work without PouchDB, depending on the quality of the implementation. Of all the tools I chose for this project, PouchDB is the one that impressed me the most for its potential to make challenging multi-user features straightforward to implement.
</p>
</div>
</div>

<div id="outline-container-sec-3-6-3" class="outline-4">
<h4 id="sec-3-6-3"><span class="section-number-4">3.6.3</span> Scripting for power users</h4>
<div class="outline-text-4" id="text-3-6-3">
<p>
Power users in any kind of application delight in the opportunity to use a scripting language to take care of tedious or challenging tasks. Because this app was built in the web browser, we already have a language with excellent support at our disposal that was designed to be easy for users to pick up and write small snippets with: JavaScript.
</p>

<p>
Since ClojureScript compiles to JavaScript, it is very easy to make such a system available. On the development side, a special module containing user-facing functions that are meant to be used from a JavaScript console could be created. ClojureScript modules are exported as JavaScript globals, so the module would be visible to the user as something like <code>[window.]ewan.script</code>. The functions could do most anything you could imagine. It might look something like this:
</p>

<div class="org-src-container">

<pre class="src src-javascript"><span class="org-comment-delimiter">// </span><span class="org-comment">a collection of functions</span>
<span class="org-keyword">const</span> <span class="org-variable-name">s</span> = window.ewan.script; 

<span class="org-comment-delimiter">// </span><span class="org-comment">imagined feature 1: a programmatic interface for making arbitrary </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">substitutions for regular expressions</span>
s.replaceAll<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"tierId"</span>, <span class="org-string">/colour/</span>g, <span class="org-string">"color"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">imagined feature 2: a more complicated interface that lets you apply a </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">function to all annotation values on a tier. Suppose we made a transcription</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">error in our words and forgot to lengthen [u] in front of voiced consonants</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">in English. We could use this function to correct the issue:</span>
s.updateAnns<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"phoneticTierId"</span>, <span class="org-keyword">function</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-variable-name">ann</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
  <span class="org-keyword">const</span> <span class="org-variable-name">text</span> = ann.value;
  <span class="org-keyword">const</span> <span class="org-variable-name">uIndex</span> = text.indexOf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"u"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">check if we have u followed by a voiced consonant (just consider [b] and [d]</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">here for simplicity) and replace with u&#720; if it is</span>
  <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>uIndex &gt; -<span class="org-highlight-numbers-number">1</span> 
      &amp;&amp; uIndex &lt; text.length - <span class="org-highlight-numbers-number">1</span>
      &amp;&amp; <span class="org-rainbow-delimiters-depth-4">[</span><span class="org-string">'b'</span>, <span class="org-string">'d'</span><span class="org-rainbow-delimiters-depth-4">]</span>.indexOf<span class="org-rainbow-delimiters-depth-4">(</span>uIndex.charAt<span class="org-rainbow-delimiters-depth-5">(</span>uIndex + <span class="org-highlight-numbers-number">1</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">)</span> &gt; -<span class="org-highlight-numbers-number">1</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
    ann.value = text.substring<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-highlight-numbers-number">0</span>, uIndex<span class="org-rainbow-delimiters-depth-4">)</span> + <span class="org-string">"u&#720;"</span> + text.substring<span class="org-rainbow-delimiters-depth-4">(</span>uIndex + <span class="org-highlight-numbers-number">1</span><span class="org-rainbow-delimiters-depth-4">)</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span>
<span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">imagined feature 3: `afterAnnotationCreated`, which executes</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">an arbitrary function after an annotation is created on a </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">specified tier. E.g., the sentence "glass isn't strong"</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">might be turned into four tokens, "glass", "is" "n't", and </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">"strong", and then these tokens would be turned into</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">individual annotations on the child tier</span>
s.afterAnnotationCreated<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"parentTierId"</span>, <span class="org-keyword">function</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-variable-name">ann</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">tokenize a sentence using a remote service--this could be</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">somewhere on the web or running on the user's machine</span>
  <span class="org-keyword">const</span> <span class="org-variable-name">response</span> = <span class="org-keyword">await</span> fetch<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"https://my.tokenizing.service/?s="</span> + ann.value<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-keyword">const</span> <span class="org-variable-name">tokens</span> = <span class="org-keyword">await</span> response.json<span class="org-rainbow-delimiters-depth-3">()</span>;
  <span class="org-keyword">for</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">let</span> <span class="org-variable-name">token</span> of tokens<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
    s.addAnnotation<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"childTierId"</span>, <span class="org-rainbow-delimiters-depth-5">{</span>parentRef: ann.annotationId,
                                    value: token.value<span class="org-rainbow-delimiters-depth-5">}</span><span class="org-rainbow-delimiters-depth-4">)</span>;
  <span class="org-rainbow-delimiters-depth-3">}</span>
<span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
A bit more on feature 3, since it has a lot of potential: although we used tokenization as an example use case for a hook like this, we could use it for automating virtually any task a user might perform after taking some kind of action in the app. Beyond tokenization, we could use the same kind of pattern to automate forced alignment, morphological parsing, syntactic parsing, semantic parsing, and other annotation tasks that may be tedious, difficult, or both.
</p>

<p>
The possibilities are endless with a user-facing API, and it's worth stressing that this feature was made possible by our choice of platform: had we not been using the browser, we would have had either implement an entire scripting language or embed an existing one (like <a href="https://en.wikipedia.org/wiki/Lua_(programming_language)">Lua</a>) into the app, neither of which gives us the rich tooling and ecosystem that JavaScript has.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Analysis</h2>
<div class="outline-text-2" id="text-4">
<p>
In this section, I'll compare each of my tools to their most common alternative. Specifically, I will discuss my choice of platform, my approach to UI components, my choice of database, and finally, my choice of language.
</p>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Browser vs. desktop and mobile</h3>
<div class="outline-text-3" id="text-4-1">
<p>
While mobile phones have an undeniable place for apps that plan to involve community members or that must be used in circumstances where a laptop is impractical, they are not suited for the kind of detailed data professional users will be entering and viewing in a langdoc app.
</p>

<p>
It would likely be possible to make a similar app for the desktop while avoiding most of its pitfalls (cross-platform support, complicated installation of dependencies, etc.), but without a positive reason to pick the desktop to begin with, the browser seems to be the clear winner.
</p>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Material-UI vs. homemade components</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Historically, most langdoc apps I'm aware of that targeted the browser implemented their own UI elements, either from scratch<sup><a id="fnr.11" name="fnr.11" class="footref" href="#fn.11">11</a></sup> or with the assistance of only a CSS framework<sup><a id="fnr.12" name="fnr.12" class="footref" href="#fn.12">12</a></sup>. Now that high-quality component libraries are available (a recent development), it cannot be overstated how much langdoc app developers could benefit from them. There is no longer a reason to bear the burden of creating and maintaining basic UI components like input elements and dropdown menus when open source libraries like <a href="https://material-ui.com/demos/autocomplete/">Material-UI</a> could take care of all this work for them.
</p>

<p>
When so much work is avoided by using a UI library, I don't think it would be justifiable to not use one if you're making a langdoc app targeting the browser. If I had created all of my UI elements from scratch with the same level of quality for EWAN, I expect I would have needed on the order of 100 more hours (i.e., ~50% of my total development time). And it would have been even more work to implement the support Material-UI has for mobile devices. 
</p>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> PouchDB + CouchDB vs. traditional database with a server application layer</h3>
<div class="outline-text-3" id="text-4-3">
<blockquote>
<p>
Because CouchDB is a web server, you can serve applications directly [to] the browser without any middle tier. When Im feeling punchy, I like to call the traditional application server stack extra code to make CouchDB uglier and slower. &#x2013; <a href="https://github.com/couchapp/couchapp/blob/master/docs/intro/what-is-couchapp.rst#the-basics">J. Chris Anderson</a>
</p>
</blockquote>

<blockquote>
<p>
If CouchDB does user authentication (its got a signup button right on the home page, for crying out loud), paging, indexing, full-text search, geo data, and it all speaks HTTP, well what does that actually leave us to do on the server?
</p>

<p>
Take a long look in the mirror, and really ask yourself! And yes, for those of you who do machine learning and scientific computing and business intelligence, I can already see you raising your hands, but for the rest of us who get paid to write Twitter clones, the answer is: not much. Your average CRUD app can magically transform into a PGPD app (PUT, GET, POST, DELETE), you can throw it up on CouchDB with some nice HTML and CSS to style it, and be at your local brewpub by 3. Or maybe you could just send the default Futon interface to the client and tell them you wrote it. &#x2013; <a href="https://nolanlawson.com/2013/11/15/couchdb-doesnt-want-to-be-your-database-it-wants-to-be-your-web-site/">Nolan Lawson</a>
</p>
</blockquote>

<p>
As we have seen, using PouchDB with CouchDB has some unbelievable benefits: it can remove <a href="https://nolanlawson.com/2013/11/15/couchdb-doesnt-want-to-be-your-database-it-wants-to-be-your-web-site/"><i>the entire server application layer</i></a> from your app, and gives you both real-time and eventual (offline) synchronization for free.
</p>

<p>
Too good to be true? Yes, it would be, if we left it at that. There are some notable downsides. Nolan Lawson <a href="https://nolanlawson.com/2013/11/15/couchdb-doesnt-want-to-be-your-database-it-wants-to-be-your-web-site/">has gone into them at length</a>, and I'll focus on the two issues I think are most worrying for langdoc apps: a limited security model, and use of a non-relational data model (documents).
</p>
</div>

<div id="outline-container-sec-4-3-1" class="outline-4">
<h4 id="sec-4-3-1"><span class="section-number-4">4.3.1</span> Security Model</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
A single CouchDB instance, like a single SQL database instance, has many <i>databases</i>. A database is just a collection of many <i>documents</i> (or rows, for a SQL DB) that are all of the same type. CouchDB supports only three kinds of security models for a given database:
</p>

<ul class="org-ul">
<li>Everyone can do everything.
</li>
<li>Some people can write (some documents), everyone can read (all documents).
</li>
<li>Some people can write (some documents), some people can read (all documents).
</li>
</ul>

<p>
This is a less powerful security model than some databases offer: <a href="https://en.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a> offers <a href="https://stackoverflow.com/questions/30295304/per-document-user-access-control-for-pouchdb-couchdb">row-level security</a>, which in PouchDB would be the equivalent of specifying what users are allowed to do per <i>document</i>.
</p>

<p>
How much of a problem is this for langdoc apps? This entirely depends on the operational structure of langdoc efforts that an app is supposed to serve. This coarse security model seems inadequate in two circumstances, which could conceivably arise in a langdoc project:
</p>

<ul class="org-ul">
<li>For a given type of data, a subset of editors may edit only a specific subset of the data
</li>
<li>Some documents (a lexical item, a recording, etc.) need exceptional privacy (e.g., at the informant's request)
</li>
</ul>

<p>
For either of these, the CouchDB community has discovered a well-known workaround: the database is partitioned into as many databases as are needed to accommodate the different security configurations, and then the documents are sent to and retrieved from the appropriate database. For example, a <code>recordings</code> database might be split into <code>recordings-public</code> (for everyone) and <code>recordings-private</code> (only for privileged users). 
</p>

<p>
This complicates application code slightly, as we now need to remember to query both databases instead of just the <code>recordings</code> database. This is not a significant burden as long as the security permutations are not too numerous, and it seems unlikely that there would be a proliferation of security classes in the average langdoc project.
</p>
</div>
</div>

<div id="outline-container-sec-4-3-2" class="outline-4">
<h4 id="sec-4-3-2"><span class="section-number-4">4.3.2</span> Schemas and document-orientation</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
Now I turn to the problem of document-orientation. While document-orientation has some benefits, such as ease of use and, in PouchDB's case, already being in our native data structure (JSON), there are downsides. The biggest one is that we don't have the data integrity guarantees that come with using a SQL database: in principle, you can insert <i>anything</i> into a PouchDB database. 
</p>

<p>
However, much of this disadvantage is mitigated by our use of spec (as seen in section 3.2). Assuming we use ClojureScript and write comprehensive specs in our app<sup><a id="fnr.13" name="fnr.13" class="footref" href="#fn.13">13</a></sup>, our only remaining worry would be that a malicious user could tamper with client code and deliberately insert bad data into PouchDB<sup><a id="fnr.14" name="fnr.14" class="footref" href="#fn.14">14</a></sup>, at which point there would be nothing left to stop this data from propagating to other nodes. This is a possibility, but not one that should be very concerning assuming all users with edit permissions are trusted<sup><a id="fnr.15" name="fnr.15" class="footref" href="#fn.15">15</a></sup>.
</p>
</div>
</div>

<div id="outline-container-sec-4-3-3" class="outline-4">
<h4 id="sec-4-3-3"><span class="section-number-4">4.3.3</span> Conclusion</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
We have seen these two shortcomings&#x2013;coarse security settings and document-orientation&#x2013;and noted that both have acceptable workarounds. One final word of caution is that while PouchDB has a <a href="https://pouchdb.com/guides/mango-queries.html">good query language based on MongoDB's</a>, it is a little idiosyncratic, and sometimes writing an <a href="https://pouchdb.com/guides/queries.html">advanced query</a> is necessary, especially if your documents have a lot of <a href="http://docs.couchdb.org/en/2.0.0/couchapp/views/joins.html">relationships which would have required joins in SQL</a>. 
</p>

<p>
If these are the only problems there are, the mind boggles at how much time using the PouchDB/CouchDB architecture saves compared to a traditional three-layered architecture with an application server in between the database and the client. As the quotes at the beginning of the section point out, some apps cry out for server code, but for CRUD apps (which a langdoc app undoubtedly is), server code is often just a repetition of what we have already written elsewhere. And let's not forget the first reason we looked at PouchDB in the first place: we get offline-first support for free.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> ClojureScript vs. JavaScript</h3>
<div class="outline-text-3" id="text-4-4">
<blockquote>
<p>
Who cares what technology you use, as long as it works, and both you and your users are happy with it? That's the beauty of new things: there's always a new one coming along. Don't let the pursuit of new, shiny things accidentally become your goal. Avoid becoming a magpie developer. Be selective in your pursuit of the shiny and new, and you may find yourself a better developer for it. &#x2013; <a href="https://blog.codinghorror.com/the-magpie-developer/">Jeff Atwood</a>
</p>
</blockquote>

<blockquote>
<p>
Our hypothesis was that if we wrote our software in Lisp, we'd be able to get features done faster than our competitors, and also to do things in our software that they couldn't do. And because Lisp was so high-level, we wouldn't need a big development team, so our costs would be lower.
</p>

<p>
[&#x2026;]
</p>

<p>
What's so great about Lisp? And if Lisp is so great, why doesn't everyone use it? [&#x2026;] Lisp is so great [&#x2026;] because it is simply the most powerful language available. And the reason everyone doesn't use it is that programming languages are not merely technologies, but habits of mind as well, and nothing changes slower. &#x2013; <a href="http://www.paulgraham.com/avg.html">Paul Graham</a>
</p>
</blockquote>

<p>
Let me begin this controversial section by repeating what should go without saying: there is no best programming language. A language can be more or less suited to a circumstance, but it's questionable to speak of an ideal programming language devoid of context. Let us ask the question in the circumstance we have been considering, then: what is the best programming language for creating a langdoc app that is comprehensive, maintainable, and extensible with the extremely finite resources that are available for it?
</p>

<p>
There are many compile-to-JS languages<sup><a id="fnr.16" name="fnr.16" class="footref" href="#fn.16">16</a></sup>, but the only two that seemed like they could possibly fit this bill were JavaScript and ClojureScript. Let's examine them in turn and see what they bring to the table in this specific context that we're considering.
</p>
</div>

<div id="outline-container-sec-4-4-1" class="outline-4">
<h4 id="sec-4-4-1"><span class="section-number-4">4.4.1</span> JavaScript</h4>
<div class="outline-text-4" id="text-4-4-1">
<ul class="org-ul">
<li>The good
<ul class="org-ul">
<li>Learnable in a day
</li>
<li>Largest extant language ecosystem
</li>
</ul>
</li>
<li>The bad
<ul class="org-ul">
<li><a href="https://medium.com/javascript-non-grata/javascript-is-a-dysfunctional-programming-language-a1f4866e186f">Inconsistent language semantics</a>
</li>
<li><a href="https://en.wikipedia.org/wiki/ECMAScript">Ever-changing language standard</a> which requires the use of JS-to-JS compilers and causes code and tool churn
</li>
<li>Very small core language that does not scratch every abstraction itch
</li>
</ul>
</li>
</ul>

<p>
Even JavaScript's most faithful users agree that it suffers from many unfortunate design decisions that reflect its creator's assumption that it would be sprinkled in by novice users, handfuls at a time. The ECMAScript committee has been busy fixing some of these deficiencies, but this has put a great maintenance burden on the community, which has been sinking much time into keeping up with the latest tools and features. 
</p>
</div>
</div>

<div id="outline-container-sec-4-4-2" class="outline-4">
<h4 id="sec-4-4-2"><span class="section-number-4">4.4.2</span> ClojureScript</h4>
<div class="outline-text-4" id="text-4-4-2">
<ul class="org-ul">
<li>The good
<ul class="org-ul">
<li>Extraordinarily consistent semantics
</li>
<li>Expansive core library rich in data structures and abstractions
</li>
<li>Stable: has not appreciably changed since 2009
</li>
</ul>
</li>
<li>The bad
<ul class="org-ul">
<li>Very unfamiliar to most programmers, out of reach for non-programmers
</li>
<li>Need to learn two languages (JS and Clojure) to use it
</li>
</ul>
</li>
</ul>

<p>
Learning a Lisp-family language is already a daunting task, and learning ClojureScript actually requires you to learn two: Clojure, and its host language on this platform, JavaScript. The boon the Clojure wizards tell you is at the end of this journey is a language that is both streamlined for practical use and uncompromising on semantic elegance, but needless to say, many langdoc app developers would not be keen on spending ~100 hours they could have been spending delivering features on learning a new language unless they're certain it would be worth their while.
</p>
</div>
</div>

<div id="outline-container-sec-4-4-3" class="outline-4">
<h4 id="sec-4-4-3"><span class="section-number-4">4.4.3</span> Conclusion</h4>
<div class="outline-text-4" id="text-4-4-3">
<p>
Unlike, say, a choice of database, I think a choice of programming language is in large part personal. Lisp fans are incredulous when they see programmers turn to less powerful but syntactically prettier languages, but the fact of the matter is that people have subjective reactions language syntax that have real effects on their productivity. And as if this handicap weren't enough, ClojureScript also all but demands that its users abandon object-oriented programming for functional programming.
</p>

<p>
Obviously, I have found that ClojureScript the most productive browser language for me, but I can't assert that it would be for you too with the same confidence that I recommended PouchDB. So, all I can do is summarize why I feel ClojureScript would be my choice if I were sitting down to write a language app:
</p>

<ul class="org-ul">
<li>I will (almost certainly) never need to change my code to keep up with a language standard
</li>
<li>I will (almost certainly) never need to replace my compiler or my build tool because it became obsolete
</li>
<li>ClojureScript is a <a href="https://clojure.org/reference/macros">programmable programming language</a><sup><a id="fnr.17" name="fnr.17" class="footref" href="#fn.17">17</a></sup> which lets you create <a href="https://en.wikipedia.org/wiki/Domain-specific_language">domain-specific languages</a> when appropriate
</li>
<li>ClojureScript's semantics are exceptionally consistent, which helps you avoid obscure bugs and ugly code
</li>
<li>ClojureScript's <a href="https://clojure.org/reference/data_structures">core data structures</a> are practical and richly featured
</li>
<li>ClojureScript's core library is expansive, offering high-quality abstractions for <a href="https://clojure.org/reference/protocols">polymorphism</a>, <a href="https://clojure.org/reference/transducers">stream processing</a>, <a href="https://clojure.org/reference/atoms">concurrency</a>, and others, letting you focus on building your app
</li>
<li>ClojureScript's tooling is stable and high-quality, offering <a href="https://github.com/clojure/clojurescript/wiki/Google-Closure">free dead code elimination</a>, <a href="https://github.com/bhauman/lein-figwheel">hot code reloading</a>, and more
</li>
</ul>

<p>
Personally, when I looked at all these benefits (most of which JavaScript is unable to offer) and the time it would take for me to learn ClojureScript, I decided it would be worth my while to make the investment. I feel that my decision has been validated by my experience writing EWAN, which would have taken significantly more time had I used JavaScript.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Conclusion</h2>
<div class="outline-text-2" id="text-5">
<p>
In this post, I have tried to show the extent to which using different tools would facilitate app development in the specific conditions langdoc developers work in. I concluded that the web browser is the only proper platform choice; that you must use a UI library for the app; that a PouchDB + CouchDB solution that omits an application server layer could be an enormous timesaver and enable the app to work offline; and that ClojureScript has many productivity-enhancing features JavaScript cannot offer. 
</p>

<p>
It's my hope that langdoc developers will fully examine all the technical options that are available to them as they build their apps in the future, and that they will be bold in learning and using a new tool if they decide that it could help them get better features to their users faster. In langdoc, we don't have much time.
</p>

<script>
var disqus_config = function () {
  this.page.url = 'https://lgessler.com/pages/2018-06-27-CHOOSING-THE-RIGHT-TOOLS-FOR-A-LANGUAGE-DOCUMENTAT.ORG';
  this.page.identifier = '/pages/2018-06-27-CHOOSING-THE-RIGHT-TOOLS-FOR-A-LANGUAGE-DOCUMENTAT.ORG';
};
(function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://lgessler-com.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
For this post, I'll treat <i>technology</i> as interchangeable with <i>application software</i> ("apps"), since this is by far the most important kind of technology in langdoc.
</p></div>

<div class="footdef"><sup><a id="fn.2" name="fn.2" class="footnum" href="#fnr.2">2</a></sup> <p class="footpara">
Two notable exceptions I'm aware of include <a href="https://software.sil.org/fieldworks/support/about-the-development-team/">SIL for FieldWorks</a> and <a href="https://tla.mpi.nl/team/">MPI for Psycholinguistics for ELAN</a>.
</p></div>

<div class="footdef"><sup><a id="fn.3" name="fn.3" class="footnum" href="#fnr.3">3</a></sup> <p class="footpara">
I am ignoring the cost associated with using one tool over another: some tools are going to take longer to learn, or require more cajoling to get your team to adopt it. A full discussion is out of scope, but I'll say that for the kind of work I'm investigating in this post&#x2014;developing a comprehensive langdoc app&#x2014;the cost of actual development ought to dwarf the cost of learning how to use the tools. Therefore we may ignore the cost of learning the tools.
</p></div>

<div class="footdef"><sup><a id="fn.4" name="fn.4" class="footnum" href="#fnr.4">4</a></sup> <p class="footpara">
The missing features are, in my opinion, irrelevant for a langdoc app: it doesn't matter that threading and OS-mediated access to peripherals like printers aren't available.
</p></div>

<div class="footdef"><sup><a id="fn.5" name="fn.5" class="footnum" href="#fnr.5">5</a></sup> <p class="footpara">
Actually, I think a "real" web app would have to have a little more packaging, such as that of a Chrome Extension. This is necessary to support certain features like offline function. Notably, <a href="https://github.com/aikuma/aikuma-ng">Aikuma-NG</a> chooses this approach.
</p></div>

<div class="footdef"><sup><a id="fn.6" name="fn.6" class="footnum" href="#fnr.6">6</a></sup> <p class="footpara">
There's been a lot of work on attempting to make frameworks that allow you to write code for both operating systems (most notably <a href="https://facebook.github.io/react-native/">React Native</a>) and even a browser as well (<a href="https://en.wikipedia.org/wiki/Apache_Cordova#Supported_platforms">Apache Cordova</a>), but the consensus I've pieced together is that while these are fine for getting 90% of the correct behavior, getting the remaining 10% both done and consistent across all target platforms is hellishly difficult and riddled with performance issues. See <a href="https://engineering.udacity.com/react-native-a-retrospective-from-the-mobile-engineering-team-at-udacity-89975d6a8102?gi=261cb1c84fae">Udacity's experience with React Native</a> for one perspective.
</p></div>

<div class="footdef"><sup><a id="fn.7" name="fn.7" class="footnum" href="#fnr.7">7</a></sup> <p class="footpara">
See <a href="https://youtu.be/3y7xzH8jB8A?t=396">Abhinav Sarkar and Kartik Gupta's talk</a> beginning at 6:36 for a comparison of their legacy Go code and equivalent Clojure code that demonstrates this beautifully.
</p></div>

<div class="footdef"><sup><a id="fn.8" name="fn.8" class="footnum" href="#fnr.8">8</a></sup> <p class="footpara">
The validation mechanism spec provides is also accomplishable in your everyday object-oriented, imperative language, probably by making an instance method <code>AnnotationDocument.validate()</code> that runs after any mutating method, but this is missing a couple of features spec has. First, the language needs to support <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/preprocessor-directives/preprocessor-if">conditional compilation</a> to avoid having the check included at runtime. Second, this approach does not give you explanations of failing specs. Third, a Clojure spec allows you to do <a href="https://github.com/clojure/test.check">property-based testing</a>, which checks user-supplied properties against generated data.
</p></div>

<div class="footdef"><sup><a id="fn.9" name="fn.9" class="footnum" href="#fnr.9">9</a></sup> <p class="footpara">
For another example of a way toa chieve this architecture, see <a href="https://news.ycombinator.com/item?id=13959156">PostgREST</a>, a library that provides a REST API on top of any PostgreSQL database. See also <a href="https://github.com/graphile/postgraphile">Postgraphile</a> for a GraphQL equivalent.
</p></div>

<div class="footdef"><sup><a id="fn.10" name="fn.10" class="footnum" href="#fnr.10">10</a></sup> <p class="footpara">
In the event there is a feature that does require this layer, there are no barriers to adding this layer only in the parts of the app that require it: the two architectures can coexist at once.
</p></div>

<div class="footdef"><sup><a id="fn.11" name="fn.11" class="footnum" href="#fnr.11">11</a></sup> <p class="footpara">
The <a href="https://github.com/dativebase/old">Online Linguistic Database</a> does not use a component library and is structured as a server-side app, though both of these choices probably have more to do with when it was created (~2011) than anything: single-page apps were rare, and component libraries didn't really exist yet.
</p></div>

<div class="footdef"><sup><a id="fn.12" name="fn.12" class="footnum" href="#fnr.12">12</a></sup> <p class="footpara">
<a href="https://www.lingsync.org/">LingSync</a> uses Bootstrap, but otherwise (as far as I can tell) implements its own components.
</p></div>

<div class="footdef"><sup><a id="fn.13" name="fn.13" class="footnum" href="#fnr.13">13</a></sup> <p class="footpara">
Other programming languages you might use in conjunction with PouchDB, like JS, also have similar libraries, like <a href="https://github.com/prayerslayer/js.spec">js.spec</a>.
</p></div>

<div class="footdef"><sup><a id="fn.14" name="fn.14" class="footnum" href="#fnr.14">14</a></sup> <p class="footpara">
This might suggest that if an attacker can edit client code that he can make <i>any</i> kind of change to the database, but this is not true. An attacker could do anything they want to to their local instance of PouchDB, but if they tried to sync these changes to the shared CouchDB instances, only the changes that the attacker has permission for on their CouchDB user account would successfully sync.
</p></div>

<div class="footdef"><sup><a id="fn.15" name="fn.15" class="footnum" href="#fnr.15">15</a></sup> <p class="footpara">
It's also worth noting that there's <a href="https://github.com/pouchdb-community/relational-pouch">a plugin for a relational API for PouchDB</a>.
</p></div>

<div class="footdef"><sup><a id="fn.16" name="fn.16" class="footnum" href="#fnr.16">16</a></sup> <p class="footpara">
There included Kotlin, Scala.js, OCaml/Reason, and Dart, among others.
</p></div>

<div class="footdef"><sup><a id="fn.17" name="fn.17" class="footnum" href="#fnr.17">17</a></sup> <p class="footpara">
<a href="http://www.defmacro.org/ramblings/lisp.html">This essay</a> is the best explanation of the value of macros and Lisp in general that I have read, and remains fairly unbiased.
</p></div>


</div>
</div></div><div class="col-md-3"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">1. Introduction</a></li>
<li><a href="#sec-2">2. Requirements and tool choices</a>
<ul class="nav">
<li><a href="#sec-2-1">2.1. Suitable platform: browser</a></li>
<li><a href="#sec-2-2">2.2. Minimal UI development: Material-UI</a></li>
<li><a href="#sec-2-3">2.3. Offline-first: PouchDB</a></li>
<li><a href="#sec-2-4">2.4. Cheap maintenance: ClojureScript</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Implementation and comparison</a>
<ul class="nav">
<li><a href="#sec-3-1">3.1. Loading and representing ELAN files</a></li>
<li><a href="#sec-3-2">3.2. Ensuring data integrity with spec</a></li>
<li><a href="#sec-3-3">3.3. Data persistence and offline support with PouchDB</a></li>
<li><a href="#sec-3-4">3.4. Free UI with Material-UI</a></li>
<li><a href="#sec-3-5">3.5. Managing state with re-frame</a></li>
<li><a href="#sec-3-6">3.6. Extensions</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Analysis</a>
<ul class="nav">
<li><a href="#sec-4-1">4.1. Browser vs. desktop and mobile</a></li>
<li><a href="#sec-4-2">4.2. Material-UI vs. homemade components</a></li>
<li><a href="#sec-4-3">4.3. PouchDB + CouchDB vs. traditional database with a server application layer</a></li>
<li><a href="#sec-4-4">4.4. ClojureScript vs. JavaScript</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Conclusion</a></li>
</ul>
</div>
</nav>
</div></div></div>
<footer id="postamble" class="">
<div class="container"><div class="row"><div class="col-md-9"><div id="disqus_thread"></div></div></div></div>
</footer>
</body>
</html>
